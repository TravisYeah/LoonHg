---
title: "Loon Hg analysis"
author: "Richard Erickson"
date: "September 2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Modelling fish Hg 

First, we modeled fish Hg using a censored regression from the NADA package, the data.table package to load and manipulate data, and the plotting2 package for plotting.

This data had some cleanup required, based upon inaccuracies and non-unique codding in the original data. 

```{r loadPackages, warning=FALSE, message=FALSE, results="hide"}
library(data.table)
library(ggplot2)
library(NADA)

## load loon blood
loonBlood <- fread("./LoonHGblood.csv")
loonBlood[ , fishLakeID := LakeID]
loonBlood[ , fishLakeID := gsub( "^0", "", fishLakeID)]

## Load data and reformat it
fishDataRaw <- fread("./fishUse.csv")
fishData <- fread("./fishUse.csv")

## Reformat data structure
fishData[ , DOWID := as.character(DOWID)]
fishData[ , HGppmLog  := log(HGppm + 1)]
fishData[ , Lgthcm := Lgthin * 2.54]
fishData[ , LgthinLog := log(Lgthin + 1)]
fishData[ , LgthcmLog := log(Lgthcm + 1)]
fishData[ , SppCut := paste(Spec, Anat, sep = "_")]
fishData[ , sampleEvent := paste(DOWID, YEAR, sep = "_")]

## Edit lake codes
## CHANGE Mantrap to match mantrap used with WQ
fishData[ WATERWAY == "MANTRAP", DOWID := '29015104']

## Change MONONGALIA to match Monogalia used with WQ
fishData[ WATERWAY == "MONONGALIA", DOWID := '34015802']

## Change BIG BIRCH to match BIG BIRCH used with WQ
fishData[ WATERWAY == "BIG BIRCH", DOWID := '77008401']

## Change VERMILION to match EAST VERMILION USED with WQ
fishData[ WATERWAY == "VERMILION", DOWID := '69037801']

## Pool all Tamarack data
fishData[ grep("3024100|3024102|9006700", DOWID), DOWID := "3024101" ]
loonBlood[ grep("3024100|3024102|9006700", fishLakeID), fishLakeID := "3024101"]

## change east fox lake to be west fox lake
loonBlood[ grep("East Fox", Lake), fishLakeID := "18029700"]
fishData[ grep("EAST FOX", WATERWAY), fishLakeID := "18029700"]

## Enter in non-detect codes 
ndCodes <- c("K", "KM", "ND")
fishData[ , ND := "no"]
fishData[ Hgcode %in% ndCodes, ND := "yes"]

## create non-detect lables
fishData[ , NDyes := 0]
fishData[ ND == "yes", NDyes := 1]
fishData[ , NDno := 0]
fishData[ ND == "no", NDno := 1]

## Remove data that has too small of number
## Total of 7 fish
dropSpp <- c("SLT_WHORG", "SF_WHORG")
fishData <- copy(fishData[ ! SppCut %in% dropSpp, ])

## Remove lake evens that have fewer than 5 fish, results in removing 1362 fish
minEvents <- 5
eventDT <- fishData[ , list(Det = sum(NDno), ND = sum(NDyes), total = length(HGppm)),
         by = sampleEvent]
eventDT[ , prop := round(ND/total, 2)] 
eventDT[ , lakeID := gsub("(\\d+)_(\\d{4})", "\\1", sampleEvent)]
eventDT[ order(total, decreasing = FALSE), ][ total < minEvents,]

sampleEventRemove <- eventDT[ total < minEvents, sampleEvent]

## May need line in code to save loon lakes
eventDT[ total < minEvents & lakeID %in%loonBloodLakeIDs, ]
fishData <- copy(fishData[ ! sampleEvent %in% sampleEventRemove, ])

## Remove sppCuts now that have >= 5 observaitons, also, make sure
## any observaiton with more than 50% ND should be removed

sppCutDT <- fishData[ , list(Det = sum(NDno), ND = sum(NDyes), total = length(HGppm)),
         by = SppCut]

sppCutDT[ , prop := round(ND/total, 2)]
sppCutDT[ order(prop, decreasing = TRUE)]
sppCutDT[ order(total, decreasing = TRUE)]

sppCutRemove <- sppCutDT[ total <= 5, SppCut]
fishData <- copy(fishData[ ! SppCut %in% sppCutRemove, ])

## Need repeate removing lakes with fewer than 5 fish
eventDT <- fishData[ , list(Det = sum(NDno), ND = sum(NDyes), total = length(HGppm)),
         by = sampleEvent]
eventDT[ , prop := round(ND/total, 2)] 
eventDT[ , lakeID := gsub("(\\d+)_(\\d{4})", "\\1", sampleEvent)]
eventDT[ order(total, decreasing = FALSE), ][ total <5,]

sampleEventRemove <- eventDT[ total < minEvents, sampleEvent]
eventDT[ total < minEvents & lakeID %in%loonBloodLakeIDs, ]

fishData <- copy(fishData[ ! sampleEvent %in% sampleEventRemove, ])

## How many samples per 
fishData[ , length(HGppm), by = SppCut][ order(V1, decreasing = FALSE),]
fishData[ , length(HGppm), by = sampleEvent][ order(V1, decreasing = FALSE),][ V1 <=5,]

fishData[ , Censor := FALSE]
fishData[ NDyes == 1, Censor := TRUE]


## merge data 
loonBloodLakeIDs <- loonBlood[ , unique(fishLakeID)]
missingLoonLakes <- loonBloodLakeIDs[!loonBloodLakeIDs %in% fishData[ , unique(DOWID)]]


## Change log transform to not include + 1
fishData[ , HGppmLog := log(HGppm)]
fishData[ , HGppbLog := log(HGppm * 1000 + 1)]



## Hg cenreg takes a while to run, so we saved it and only run it if it needs to be run
if( !"fishHGmodel.rda" %in% list.files()){
## Run model
modelOut <-
           cenreg( Cen(fishData$HGppbLog, fishData$Censor) ~
                       fishData$LgthcmLog : fishData$SppCut  +
                       fishData$sampleEvent - 1, dist = 'gaussian')
save(modelOut, file = "fishHGmodel.rda")
} else {
load("fishHGmodel.rda")
}
summary(modelOut)

fishData[ , resids := NULL]
fishData[ , resids := residuals(modelOut)]

ggplot(fishData, aes(x = HGppmLog, y = resids)) + geom_point()

## Predict 12 cm perch Hg 
## Extract coef to mannual estimate lakes effects
coefEst <- coef(modelOut)
head(coefEst)
names(coefEst) <- gsub("fishData\\$sampleEvent", "", names(coefEst))
head(coefEst)
coefEstDT <- data.table(ce = coefEst, sampleEvent = names(coefEst))
coefEstDT[ , LakeID :=  gsub("(\\d+)_(\\d+)", "\\1", sampleEvent)]
coefEstDT[ , Year :=  gsub("(\\d+)_(\\d+)", "\\2", sampleEvent)]

coefEstDT[ , Year := as.numeric(Year)]
coefEstDT <- coefEstDT[ !is.na(Year),]


lastYearDT <- coefEstDT[ , list(lastYear = max(Year)), by = LakeID]
setkey(lastYearDT, "LakeID")
setkey(coefEstDT, "LakeID")
coefEstDT <- lastYearDT[coefEstDT]

loonBlood[ , useYear := numeric(dim(loonBlood)[1])]
loonBlood[ useYear == 0, useYear := NA]

## Somewhere loon bands were lost when the loon files were edited.
loonBandsToUse <- loonBlood[ !LakeID %in% missingLoonLakes, Band]
loonBlood <- loonBlood[ !LakeID %in% missingLoonLakes, ]

for(band in loonBandsToUse){
    indexLakeID <-
        loonBlood[ Band == band, fishLakeID][1]
    indexLoonYear <-
        loonBlood[ Band == band, Year][1]
   ## Find year closest to observed year
    useLoonYear <-       
        coefEstDT[ LakeID == indexLakeID, Year][
                       which( abs(coefEstDT[ LakeID == indexLakeID, Year] -
                                      indexLoonYear) ==
                                          min(abs(coefEstDT[ LakeID ==
                                                                indexLakeID,
                                                            Year] -
                                                                indexLoonYear)))]
    loonBlood[ Band == band, useYear := useLoonYear]
}


loonBlood[ , fishSampleEvent := paste( fishLakeID, useYear, sep = "_")]
setkey(loonBlood, "fishSampleEvent")
setkey(coefEstDT, "sampleEvent")

coefEstDT[ , c('LakeID', 'lastYear', 'Year') := NULL]
setnames(coefEstDT, "ce", "intercept")

loonBlood <- copy(coefEstDT[loonBlood])


## Used 12 cm (15 + 1 from log transform)
loonBlood[ , perchHG := intercept + coefEst[grep("SppCutYP_WHORG",
                            names(coefEst))] * log(1 + 1)]
loonBlood

write.csv(x = loonBlood[ , list(LakeID, Lake, perchHG, useYear, Year, fishLakeID)],
           file = "perchLoonHGData.csv", row.names = FALSE)








```


## Analying loon data

The fish Hg data was used as a predictor variable in the loon analysis. This data included into an input file with the other input data (code not included).

```{r loonData, echo = TRUE}
# Load libraries 
library(data.table)
library(psych)
library(ggplot2)
library(GGally)
library(lme4)
library(lmerTest)
library(lubridate)

## Load data

d <- fread("./LoonData.csv")

## grab only the columns needed to analyze the data 
## And then reformat the data
dHg <- d[ , list(perchHG, lakeYearID, Year, Lake, SECCHI, PH,
                 Phosp, ALK, CHLA, AREA, MAXdepth, TSI, Age, Sex,
                 Mercury, Mass, Selenium, Date)]
dHg[ , Mass := as.numeric(Mass)]
dHg[ , HgLog := log(Mercury)]
dHg[ , Date := as.POSIXct(strptime(Date, format = "%Y-%m-%d"))]
dHg[ , Month := month(Date)]
dHg[ , Day := day(Date)]

dHG2 <- copy(dHg)

## Exculde unkown sex adult
dHG2[ , which(Age == "Adult" & Sex == "Unknown")]
dHG2 <- copy(dHG2[ - dHG2[ , which(Age == "Adult" & Sex == "Unknown")],])

dHG2[ , Sex := factor(Sex)]
levels(dHG2$Sex)[3] <- "Juvenile"
dHG2[ , Sex := factor(Sex)]

### code for marginal plots   
perchBySex <- ggplot(data = dHG2, aes(x = perchHG, y = HgLog)) +
    geom_point() + stat_smooth(method = "lm", formula = y ~ x) +
        facet_grid( . ~ Sex) +
            theme_bw() +
                ylab(expression("ln(Loon blood Hg(" * mu*"g/g wet weight))")) +
                    xlab(expression("ln(Standardized perch Hg(" * mu*"g/g wet weight) + 1)")) +
                        theme(strip.background = element_blank())
perchBySex
ggsave("perchBySex.pdf", perchBySex, width = 8, height = 4)

onlyHG <- ggplot(data = dHG2, aes(x = perchHG, y = HgLog)) +
    geom_point() + stat_smooth(method = "lm", formula = y ~ x) +
            theme_bw() +
                ylab(expression("ln(Loon blood Hg(" * mu*"g/g wet weight))")) +
                    xlab(expression("ln(Standardized perch Hg (" * mu*"g/g wet weight) + 1)")) +
                        theme(strip.background = element_blank())
onlyHG
ggsave("onlyHG.pdf", onlyHG, width = 6, height = 4)

hgMass <- ggplot(data = dHG2, aes(x = Mass, y = HgLog)) +
    geom_point() + stat_smooth(method = "lm", formula = y ~ x) +
        facet_grid( . ~ Age) +
            theme_bw() +
                ylab(expression("ln(Loon blood Hg(" * mu*"g/g wet weight))")) +
                    xlab(expression("Mass (kg)")) +
                        theme(strip.background = element_blank())
hgMass
ggsave("hgMass.pdf", hgMass, width = 8, height = 4)


sexPlot <- ggplot(data = dHG2, aes(x = Sex, y = HgLog)) +
    ylab(expression("ln(Loon blood Hg(" * mu*"g/g wet weight))")) +
        xlab("Loon sex/age category") + 
    geom_boxplot() + theme_bw()
sexPlot
ggsave("sexPlot.pdf", sexPlot, width = 6, height = 4)


ggplot(data = dHG2, aes(x = Month, y = HgLog, color = Sex)) +
    geom_point() +
        scale_color_manual(values = c('blue', 'red', 'black'))

## Analysis
out <- lm(HgLog ~ perchHG + Sex + Mass:Age, data = dHG2)
summary(out)
confint(out, level = 0.95)

par(mfcol = c(2,2))
plot(out)

pdf("LoonHGresid.pdf")
par(mfcol = c(2,2))
plot(out)
dev.off()


#########################
Lake <- dHG2[ , list(
    perchHGLake = mean(perchHG),
    ALKLake = mean(ALK),
    SECCHILake = mean(SECCHI),
    PHLake = mean(PH),
    PhospLake = mean(Phosp),
    CHLALake = mean(CHLA),
    MAXdepthLake = mean(MAXdepth),
    AreaLake = mean(AREA)
    ), by = Lake]

Lake[ order(perchHGLake, decreasing = TRUE), list(Lake, perchHGLake, MAXdepthLake)]
ggpairs(Lake[ , -1, with = FALSE])
corr.test(Lake[ , -1, with = FALSE])
cor.test(Lake$PHLake, Lake$perchHGLake)

summary(lm(perchHGLake ~ PHLake + ALKLake +
               SECCHILake + MAXdepthLake + PhospLake + AreaLake,
           data = Lake))

ggplot(data = d, aes(x = Mercury, y = Selenium)) + geom_point() +
    scale_x_continuous(trans = 'log')+
        scale_y_continuous(trans = 'log') +
            stat_smooth(method = 'lm')

###
HgSeHist <- ggplot(dHg, aes(x = Selenium)) + geom_histogram() +
    scale_x_continuous(trans = 'log') +
        facet_grid( . ~ Sex) + theme_minimal()
print(HgSeHist)
ggsave("HgSeHist.pdf", HgSeHist, width = 6, height = 4)

dHg[ , HgLog := log(Mercury)]
dHg[ , SeLog := log(Selenium)]

HgSeBoxplot <- ggplot(dHg, aes(x = Sex, y = Selenium)) + geom_boxplot() + 
	theme_minimal()
print(HgSeBoxplot)
ggsave("HgSeBoxplot.pdf", HgSeBoxplot, width = 6, height = 4)
ggsave("HgSeBoxplot.jpg", HgSeBoxplot, width = 6, height = 4)

dHg[ , Sex := factor(Sex)]
levels(dHg$Sex)[3] <- 'Juvenile'

seAndHg <- ggplot(dHg, aes(y = SeLog, x = HgLog)) +
          geom_point() + stat_smooth(method = 'lm') +
          facet_grid( . ~ Sex) + theme_bw() + 
          theme(
              strip.background = element_rect(colour = NA, fill = NA),
              panel.border = element_rect(colour = "black") ) + 
        ylab(expression("ln(Loon blood Se (" * mu*"g/g wet weight))")) +
        xlab(expression("ln(Loon blood Hg (" * mu*"g/g wet weight))"))
seAndHg
ggsave("seAndHg.jpg", seAndHg, width = 6, height = 3)
ggsave("seAndHg.pdf", seAndHg, width = 6, height = 3)

## Examine correlation between Hg and selenimum
print( corr.test( dHg[ , list(HgLog, SeLog)]), short = FALSE)

### Start of Se analysis
dSe <- dHg[ SeLog != -Inf,]
dSe <- copy(dSe[ - dSe[ , which(Age == "Adult" & Sex == "Juvenile")],])

summary(lm(SeLog ~ Sex  + Mass, data = dSe))
round(confint(lm(SeLog ~ Sex  + Mass, data = dSe)), 2)

dSe[ , Sex := factor(Sex)]
sexPlotSe <- ggplot(data = dSe, aes(x = Sex, y = SeLog)) +
    ylab(expression("ln(Loon blood Se (" * mu*"g/g wet weight))")) +
        xlab("Loon sex/age category") + 
    geom_boxplot() + theme_bw()
sexPlotSe
ggsave("sexPlotSe.pdf", sexPlotSe, width = 6, height = 4)

cor(dSe$SeLog, dSe$HgLog)
cor.test(dSe$SeLog, dSe$HgLog)

LakeSe <- dSe[ , list(
    SeLogLake = mean(SeLog),
    ALKLake = mean(ALK),
    SECCHILake = mean(SECCHI),
    PHLake = mean(PH),
    PhospLake = mean(Phosp),
    CHLALake = mean(CHLA),
    MAXdepthLake = mean(MAXdepth),
    AreaLake = mean(AREA)
    ), by = Lake]

ggpairs(LakeSe[ , -1, with = FALSE])
corr.test(LakeSe[ , -1, with = FALSE])

## convert to molar
dSe[ , SeMol := Selenium/78.96]
dSe[ , HgMol := Mercury/1000/200.59] 

dSe[ , HgToSe := HgMol / SeMol]

ggplot(data = dSe, aes(x = HgToSe)) +
    geom_histogram() +
        facet_grid( . ~ Sex)

ggplot(data = dSe, aes(x = Sex, y = HgToSe)) +
    geom_boxplot(notch = TRUE)

ggplot(data = dSe, aes(x = Mercury, y = HgToSe)) +
    geom_point() + stat_smooth(method = 'lm')

summary(lm(HgToSe ~ Sex  + Mass, data = dSe))
round(confint(lm(HgToSe ~ Sex  + Mass, data = dSe)), 2)
```


## Session Info

```{r sessionDetails, echo=TRUE}
sessionInfo()
```

