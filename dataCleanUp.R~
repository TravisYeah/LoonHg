library(data.table)

## Load data, grab columns we need
fishData <- fread("./inputData/ALLFISH2015-HgPCBPFOS_MN.csv")

fishData[ , unique(Hgcode)]
head(fishData)
fishDataUse <- fishData[ , list(WATERWAY, DOWID, YEAR, Spec, Anat, Nofish,
                                Lgthin, HGppm, Hgcode)]

fishDataUse2 <- copy(fishDataUse[ complete.cases(fishDataUse), ])
summary(fishDataUse2)

## Check species code for codes not part of key
## and make sure we are using the same code for all species
fishKey <- fread("./inputData/sppCode.csv")
setnames(fishKey, "CODE-AFS", "AFS")
setnames(fishKey, "CODE-STORET", "STORET")

fishKey[ AFS == STORET, AFS := ""]
fishKey[ AFS == STORET, ]

fishDataUse2[ , Spec := factor(Spec)]
fishInAFS <- fishDataUse2[ Spec %in% fishKey[, AFS], unique(Spec)] 
fishInAFS


for( spp in fishInAFS){
    fishDataUse2[ Spec == spp, Spec := fishKey[ AFS == spp, STORET]]
}

fishDataUse2[ , Spec := factor(Spec)]
fishDataUse2[ Spec %in% fishKey[, AFS], unique(Spec)] 
fishDataUse2[ , unique(Spec)]

fishDataUse2[ !Spec %in% fishKey[, STORET], unique(Spec)]


## Rename cuts to be the same
fishDataUse2[ , length(HGppm), by = Anat]
fishDataUse2[ , unique(Anat)]
fishDataUse2[ Anat == "FLDP", Anat := "PLUG"]
fishDataUse2[ Anat == "WHORT", Anat := "WHORG"]
fishDataUse2[ Anat == "PLUSK", Anat := "FILSK"]
fishDataUse2[ Anat == "PLUG", Anat := "FILET"]
fishDataUse2[ , unique(Anat)]

fishDataUse2[ , length(HGppm), by = Anat]


## Remvoe data without enough types per cut
## AnatToUse <- fishDataUse2[ , length(HGppm), by = Anat][ 1:3, Anat]
AnatToUse <- c("FILSK", "FILET", "WHORG")
fishDataUse3 <- copy(fishDataUse2[ Anat %in% AnatToUse, ])

## remove data without enough spec data
SppToKeep <- fishDataUse3[ , length(HGppm), by = Spec][ V1 > 30, Spec]

fishDataUse4 <- copy(fishDataUse3[ Spec %in%  SppToKeep, ])
hist(fishDataUse4[ , YEAR])

fishDataUse5 <- fishDataUse4[ YEAR > 1979,  ]
dim(fishDataUse4)
dim(fishDataUse5)

## Currently using all years of data
write.csv(file = "./inputData/fishUse.csv", fishDataUse4)





#####
## loonData <- fread("./inputdata/MNLoonMercury.csv")
## head(loonData)
